# timeflux example using LSL as central data hub without connected neuroomega
# run as: timeflux -d -e TIMEFLUX_HOOK_PRE=aDBS_init graphs/aDBS/test_without_neuroomega.yml
# view at: http://localhost:8000/monitor/

graphs:

  # Signal processing graph: Fetches samples and computes biomarkers
  - id: SignalProcessing
    # NODES ------------------------------
    nodes:
    # Input node: Fetches samples from tmsi device
    - id: TmsiSampler
      module: nodes.TMSi.tmsi_sampler
      class: Tmsisampler
    # Window node: Implements a sliding window over the input data
    - id: SlideWindow
      module: timeflux.nodes.window
      class: Slide
      params:
        length: 1
        step: 0.1
    # Signal processing node: Compute biomarker
    - id: Mean
      module: nodes.analysis.mean
      class: Mean
    # Output nodes: LSL node sending data to LSL stream
    - id: LSL_Saga
      module: nodes.data_flow.lsl
      class: Send
      params:
        name: Saga
    - id: LSL_Mean
      module: nodes.data_flow.lsl
      class: Send
      params:
        name: Mean
    # EDGES ------------------------------   
    edges: 
      - source: TmsiSampler
        target: SlideWindow
      - source: SlideWindow
        target: Mean
      - source: TmsiSampler
        target: LSL_Saga
      - source: Mean
        target: LSL_Mean
    rate: 0  # Run this graph x times per second

  # Stimulation graph: Receives biomarker and controls stimulation
  - id: Stimulation
  # NODES ------------------------------
    nodes:
    # Input nodes: Receive data from LSL stream
    - id: LSL_Mean
      module: nodes.data_flow.lsl
      class: Receive
      params:
        prop: name
        value: Mean
        max_samples: 1
    # Control node: Check biomarker and adjust stimulation parameters
    - id: SingleThreshold
      module: nodes.stimulation.single_threshold
      class: Single_threshold
    # Stimulator node: Controls stim params on neuroomega
    - id: Stimulator
      module: nodes.AO.AO_stim_matlab
      class: AO_stim
     # Output nodes: LSL node sending data to LSL stream
    - id: LSL_StimParams
      module: nodes.data_flow.lsl
      class: Send
      params:
        name: StimParams
    # EDGES ------------------------------   
    edges: 
      - source: LSL_Mean
        target: SingleThreshold
      - source: SingleThreshold
        target: Stimulator
      - source: Stimulator
        target: LSL_StimParams
    rate: 0  # Run this graph x times per second

  # Monitor graph: Receives data from broker and visualizes it
  - id: Monitor
    nodes:
    # NODES ------------------------------
    # Input nodes: Receive data from LSL stream
    - id: LSL_Saga
      module: nodes.data_flow.lsl
      class: Receive
      params:
        prop: name
        value: Saga
    - id: LSL_Mean
      module: nodes.data_flow.lsl
      class: Receive
      params:
        prop: name
        value: Mean
    - id: LSL_StimParams
      module: nodes.data_flow.lsl
      class: Receive
      params:
        prop: name
        value: StimParams
    # UI node: Receives data from subscribers and plots them
    - id: Synchronizer
      module: nodes.data_flow.sync
      class: Synchronizer
    - id: UI
      module: timeflux_ui.nodes.ui
      class: UI
    # EDGES ------------------------------   
    edges:
      - source: LSL_Saga
        target: Synchronizer:Saga
      - source: LSL_Mean
        target: Synchronizer:Mean
      - source: LSL_StimParams
        target: Synchronizer:StimParams
      - source: Synchronizer:Saga
        target: UI:Saga
      - source: Synchronizer:Mean
        target: UI:Mean
      - source: Synchronizer:StimParams
        target: UI:StimParams
    rate: 30

  