# timeflux workflow using ZeroMQ (Publishing and Subscribing)

# PM running instructions: 
#   run from: cd C:\Users\habetsj\Research\projects\aDBS_C04\code\pyaDBS_ReTuneC04
# or Labor: cd C:\CODE\tasks\pyaDBS_ReTuneC04
#   cmd: timeflux -d graphs/aDBS/wp1b_dev.yml
# view at: http://localhost:8000/monitor/

# old notes:
# TODO: solve FFT problem with x.real() with imported value in wrong float type
# TODO: apply LSL in dummy workflow

graphs:

  ### Standard Publish/subscribe broker graph
  - id: Broker
    nodes:
    # Allow communication between graphs
    - id: broker
      module: timeflux.nodes.zmq
      class: Broker
  

  ### Main Experiment graph
  - id: MainExperiment
    # Nodes: executing classes in exp part
    nodes:

    # GET DATA: Receive ephys signal from neural sampler
    - id: tmsi_sampler
      module: nodes.TMSi.tmsi_sampler
      class: Tmsisampler
      params:
        config_filename: "config_wp1b.json"

    # SIGNAL PROCESSING NODES
    - id: biomarker
      module: nodes.analysis.biomarker
      class: Biomarker
      params:
        config_filename: "config_wp1b.json"

    # aDBS DECISION MAKING NODES
    - id: compare_biomarker
      module: nodes.aDBS.compare_input
      class: Compareinput
      params:
        config_filename: "config_wp1b.json"
      
    - id: single_threshold
      module: nodes.aDBS.single_threshold
      class: Single_threshold
      params:
        config_filename: "config_wp1b.json"

    # Stimulation Nodes
    - id: AO_Stim
      module: nodes.AO.AO_stim_matlab
      class: AO_stim
      params:
        config_filename: "config_wp1b.json"
    
    # INTER GRAPH COMM. PUBLISHING NODES
    - id: Pub_raw_sig
      module: timeflux.nodes.zmq
      class: Pub
      params:
        topic: raw_tmsi
    - id: Pub_biomarker
      module: timeflux.nodes.zmq
      class: Pub
      params:
        topic: biomarker
    - id: Pub_comp_biomarker
      module: timeflux.nodes.zmq
      class: Pub
      params:
        topic: comp_marker
    - id: Pub_aDBS_Thresh
      module: timeflux.nodes.zmq
      class: Pub
      params:
        topic: aDBS_single_thresh
    - id: Pub_AO
      module: timeflux.nodes.zmq
      class: Pub
      params:
        topic: AO_ampl
    
    # Edges: communication between internal nodes within exp graph
    edges:
      
      # Communication for exp workflow
      - source: tmsi_sampler
        target: biomarker
      - source: biomarker
        target: compare_biomarker
      - source: compare_biomarker
        target: single_threshold
      - source: single_threshold
        target: AO_Stim


      # Communication for visualization
      - source: tmsi_sampler
        target: Pub_raw_sig
      - source: biomarker 
        target: Pub_biomarker
      - source: compare_biomarker
        target: Pub_comp_biomarker
      - source: single_threshold
        target: Pub_aDBS_Thresh
      - source: AO_Stim 
        target: Pub_AO
    
    # Define update rate (times poer second)
    rate: 0  # 0 means as fast as possible

  ### Visualization Graph
  - id: Monitoring
    nodes:
    # nodes to collect monitoring streams
    - id: sub_raw
      module: timeflux.nodes.zmq
      class: Sub
      params:
        topics: raw_tmsi   #[raw_stn, raw_ecog]  bands_tmsi
    - id: sub_stim_input
      module: timeflux.nodes.zmq
      class: Sub
      params:
        topics: acc_output  # [bands_stn, bands_ecog]
    - id: sub_stim_output
      module: timeflux.nodes.zmq
      class: Sub
      params:
        topics: AO_Stim_output

    # nodes to visualize collected streams
    - id: monitor
      module: timeflux_ui.nodes.ui
      class: UI
    edges:
      # plot raw tmsi
      - source: sub_raw:raw_tmsi
        target: monitor:raw_tmsi  # monitor target is not defined before
      # plot bands of tmsi
      # - source: sub_bands:bands_tmsi
      #   target: monitor:bands_tmsi
      # plot input signal to AO-stim
      - source: sub_stim_input:acc_output
        target: monitor:acc_output
      - source: sub_stim_output:stim_output
        target: monitor:stim_output
      - source: sub_stim_output:AO_Stim_output
        target: monitor:AO_Stim_output

    rate: 0
